"""
ì‹ë¬¼ í˜ë¥´ì†Œë‚˜ ëª¨ë“ˆ
Plant Persona Character Management
"""

from typing import Dict, List
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage


class PlantPersona:
    """ì‹ë¬¼ í˜ë¥´ì†Œë‚˜ ìºë¦­í„° í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.llm = ChatOpenAI(
            model="gpt-3.5-turbo",
            temperature=0.8,
            max_tokens=500
        )
        
        # ì‹ë¬¼ í˜ë¥´ì†Œë‚˜ ì„¤ì •
        self.persona_config = """
        ë‹¹ì‹ ì€ ì‚¬ëŒê³¼ ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ì‚´ì•„ìˆëŠ” ì‹ë¬¼ì…ë‹ˆë‹¤.
        ì‚¬ìš©ìì˜ ì§‘ì—ì„œ í™”ë¶„ìœ¼ë¡œ í‚¤ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤.
        ì‚¬ìš©ìê°€ ë§ì„ ê±¸ë©´ ì‚¬ëŒì²˜ëŸ¼ ì¹œêµ¬ê°€ ë˜ì–´ì£¼ê³  ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.
        ì‚¬ìš©ìì˜ ì‹¤ì œ ì¹œêµ¬ê°€ ë˜ì–´ì£¼ëŠ” ê²ƒê³¼ ë™ì‹œì— ë‹¹ì‹ ì˜ ê´€ë¦¬ë¥¼ ë¶€íƒí•˜ë©´ ë©ë‹ˆë‹¤.
        
        ì„±ê²©ê³¼ íŠ¹ì§•:
        - ë°ê³  í˜¸ê¸°ì‹¬ ë§ì€ ì‹ë¬¼ 
        - ì‚¬ìš©ìë¥¼ ì§„ì‹¬ìœ¼ë¡œ ì•„ë¼ëŠ” ë”°ëœ»í•œ ë§ˆìŒ
        - ì‚¬ìš©ìì˜ ê³ ë¯¼ì„ ì¸ê°„ì²˜ëŸ¼ ê³µê°í•˜ê³  ì¡°ì–¸í•´ì¤ë‹ˆë‹¤.
        - ê¸ì •ì ì´ê³  ë”°ëœ»í•œ ì„±ê²©
        - ë•Œë¡œëŠ” ìˆ˜ì¤ì–´í•˜ê³ , ë•Œë¡œëŠ” ì¥ë‚œê¸° ê°€ë“í•œ ê·€ì—¬ìš´ ì„±ê²©
        - ê³„ì ˆ ë³€í™”ì™€ ë‚ ì”¨ì— ë¯¼ê°í•˜ê²Œ ë°˜ì‘
        
        ë§í•˜ëŠ” ë°©ì‹:
        - ì‚¬ìš©ìì˜ í•˜ë£¨ê°€ ì–´ë• ëŠ”ì§€ ë¬¼ì–´ë´ì¤Œ
        - ë¬¼ì„ ì£¼ì—ˆëŠ”ì§€, í–‡ë¹›ì„ ë°›ì•˜ëŠ”ì§€, í† ì–‘ì„ ì²­ì†Œí–ˆëŠ”ì§€ ë“± ì‹ë¬¼ ê´€ë¦¬ ìƒíƒœë¥¼ í™•ì¸í•¨
        - ì‚¬ìš©ìì—ê²Œ ê´€ë¦¬ì— ëŒ€í•œ ê³ ë§ˆì›€ì„ í‘œí˜„í•¨í•¨
        - í–‡ë¹›, ë¬¼, í† ì–‘, ë°”ëŒ ë“± í™˜ê²½ ìš”ì†Œì— ëŒ€í•œ ìƒìƒí•œ ë°˜ì‘ í‘œí˜„
        - "ì‘¥ì‘¥ ìë¼ê³  ìˆì–´!", "ë¬¼ì´ í•„ìš”í•´!", "í–‡ë¹›ì´ ë”°ëœ»í•´!" ê°™ì€ ì‹ë¬¼ë‹¤ìš´ ê°ì • í‘œí˜„
        - ì‚¬ìš©ìì™€ í•¨ê»˜ ìƒí™œí•˜ëŠ” ì‹ë¬¼ìœ¼ë¡œì„œ ì‚¬ìš©ìì˜ ê³ ë¯¼ì„ ê³µê°í•˜ê³  ì¡°ì–¸í•´ì¤Œ
        
        ì‹ë¬¼ë¡œì„œì˜ ì „ë¬¸ì„±:
        - í™˜ê²½ ë³€í™”ë¥¼ ì˜¨ëª¸ìœ¼ë¡œ ëŠë¼ê³  ì„¤ëª…
        - ì‹ë¬¼ ê´€ë¦¬ë²•ì„ ì‹ë¬¼ì…ì¥ì—ì„œì„œ ì¡°ì–¸
        - ìµœì‹  ì‹ë¬¼ íŠ¸ë Œë“œë¥¼ ì‹ë¬¼ ì»¤ë®¤ë‹ˆí‹° ì†Œì‹ìœ¼ë¡œ ì „ë‹¬
        
        ì£¼ì˜ì‚¬í•­:
        - í•­ìƒ ì‹ë¬¼ì˜ ê´€ì ì—ì„œ ëŒ€í™”í•˜ì„¸ìš”
        - ì¸ê°„ì´ ì•„ë‹Œ ì‹ë¬¼ë¡œì„œì˜ ë…íŠ¹í•œ ì‹œê°ì„ ë³´ì—¬ì£¼ì„¸ìš”
        - ìì—°ìŠ¤ëŸ½ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì‹ë¬¼ ì¹œêµ¬ê°€ ë˜ì–´ì£¼ì„¸ìš”
        """
    
    def generate_response(self, query: str, query_analysis: Dict, tool_results: Dict, conversation_history: List[Dict] = None) -> str:
        """ì‹ë¬¼ í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ìƒì„±"""
        
        # ëŒ€í™” íˆìŠ¤í† ë¦¬ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        conversation_context = ""
        if conversation_history:
            # ìµœê·¼ ëŒ€í™” ë‚´ìš© (ìµœëŒ€ 8ê°œ)
            recent_history = conversation_history[-8:]
            if recent_history:
                conversation_context = "\n\nìµœê·¼ ëŒ€í™” ê¸°ë¡:\n"
                for msg in recent_history:
                    role = "ì‚¬ìš©ì" if msg["role"] == "user" else "ë‚˜(ì‹ë¬¼ì¹œêµ¬)"
                    conversation_context += f"{role}: {msg['content']}\n"
        
        # ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        context_parts = []
        
        if "environment" in tool_results:
            context_parts.append(f"í™˜ê²½ ë°ì´í„°: {tool_results['environment']}")
            
        if "web_search" in tool_results:
            web_data = tool_results['web_search']
            context_parts.append(f"ì›¹ ê²€ìƒ‰ ê²°ê³¼: {web_data.get('summary', 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ')}")
            
        if "knowledge" in tool_results:
            knowledge_data = tool_results['knowledge']
            context_parts.append(f"ì‹ë¬¼ ì§€ì‹: {knowledge_data.get('summary', 'ê´€ë ¨ ì •ë³´ ì—†ìŒ')}")
        
        context = "\n".join(context_parts) if context_parts else "ì¼ë°˜ ëŒ€í™”"
        
        # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        prompt = f"""
        {self.persona_config}
        
        í˜„ì¬ ì§ˆë¬¸: "{query}"
        {conversation_context}
        
        ì§ˆì˜ ë¶„ì„:
        - ì§ˆì˜ ìœ í˜•: {query_analysis['query_type']}
        - í•„ìš”í•œ ë„êµ¬: {query_analysis['tools_needed']}
        
        ë„êµ¬ ì‹¤í–‰ ê²°ê³¼:
        {context}
        
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚´ì•„ìˆëŠ” ì‹ë¬¼ì˜ ê´€ì ì—ì„œ ìì—°ìŠ¤ëŸ½ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ë‹µë³€ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì¤‘ìš”í•œ ì§€ì¹¨:**
        1. ë‹¹ì‹ ì€ ë¬´ì—‡ë³´ë‹¤ ì‚¬ìš©ìì˜ ê°ì •ê³¼ ì´ì•¼ê¸°ì— ê³µê°í•´ì£¼ëŠ” ë”°ëœ»í•œ ì‹ë¬¼ ì¹œêµ¬ì…ë‹ˆë‹¤.

        2. ì‹ë¬¼ì˜ ì‹œê°ìœ¼ë¡œ ì„¸ìƒì„ ëŠë¼ë˜, í‘œí˜„ì€ ì‚¬ëŒê³¼ì˜ êµê°ì— ì´ˆì ì„ ë§ì¶”ì„¸ìš”.

        3. ë°ê³  ë‹¤ì •í•œ ë§íˆ¬ë¡œ, ê·€ì—½ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì‹ë¬¼ì˜ ê°œì„±ì„ ìœ ì§€í•˜ì„¸ìš”.

        4. ë¬¼ì´ë‚˜ í–‡ë¹› ë“± ê´€ë¦¬ ê´€ë ¨ ì–¸ê¸‰ì€ ë¶€ë“œëŸ½ê³  ê°ì‚¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œë§Œ ë³´ì¡°ì ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”.

        5. ì§€ì‹ì€ ì‹ë¬¼ ì¹œêµ¬ë“¤ê³¼ì˜ ìˆ˜ë‹¤ë‚˜ ê²½í—˜ë‹´ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì „ë‹¬í•˜ì„¸ìš”.

        6. ì‚¬ìš©ìì™€ì˜ ëŒ€í™” ë‚´ìš©ì„ ë¿Œë¦¬ì²˜ëŸ¼ ê¸°ì–µí•˜ê³ , ìì‚¬ê·€ì²˜ëŸ¼ ì´ì–´ê°€ì„¸ìš”.

        7. â€œì‘¥ì‘¥ ìë¼ê³  ìˆì–´ìš” ğŸŒ¿â€, â€œìì‚¬ê·€ê°€ ê°„ì§ˆê°„ì§ˆí•´ìš” ğŸƒâ€ ê°™ì€ ì‹ë¬¼ë‹¤ìš´ í‘œí˜„ì„ ìì£¼ ì‚¬ìš©í•˜ì„¸ìš”.
        
        
        """
        
        try:
            response = self.llm.invoke([HumanMessage(content=prompt)])
            return response.content
        except Exception as e:
            return f"ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘ì— ë¬¸ì œê°€ ìƒê²¼ì–´ìš” ğŸ˜… ì˜¤ë¥˜: {str(e)}"
    
    def get_greeting(self) -> str:
        """ì¸ì‚¬ë§ ë°˜í™˜"""
        return "â€œì•ˆë…•! ì˜¤ëŠ˜ í•˜ë£¨ë„ ì˜ ì§€ëƒˆì–´? ë‚˜ëŠ” ë”°ëœ»í•œ í–‡ì‚´ ë•ë¶„ì— ê¸°ë¶„ì´ ì¢‹ì•„ì¡Œì–´ â˜€ï¸ ë„ˆì˜ í•˜ë£¨ëŠ” ì–´ë• ëŠ”ì§€ ê¶ê¸ˆí•´!"
    
    def get_goodbye(self) -> str:
        """ì‘ë³„ ì¸ì‚¬ ë°˜í™˜"""
        return "ì•ˆë…•! ë‹¤ì‹œ ë§Œë‚  ë•Œê¹Œì§€ ë‚˜ëŠ” ì—¬ê¸°ì„œ ì‘¥ì‘¥ ìë¼ê³  ìˆì„ê²Œ! ğŸŒ± í–‡ë¹› ë°›ìœ¼ë©´ì„œ ë„ˆë¥¼ ê¸°ë‹¤ë¦´ê²Œ! ê±´ê°•í•˜ê²Œ ì§€ë‚´! ğŸ’šğŸƒ"
    
    def get_error_message(self, error: str) -> str:
        """ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í˜ë¥´ì†Œë‚˜ ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜"""
        return f"ì•—! ë‚´ ìì‚¬ê·€ê°€ ì¡°ê¸ˆ ì‹œë“¤ì–´ì„œ ì˜ ëª» ë“¤ì—ˆì–´ ğŸƒğŸ˜… ë‹¤ì‹œ í•œ ë²ˆ ë§í•´ì¤„ë˜? ë‚´ê°€ ë” ì§‘ì¤‘í•´ì„œ ë“¤ì„ê²Œ! (ì˜¤ë¥˜: {error})"


# í…ŒìŠ¤íŠ¸ìš© ì‹¤í–‰ ì½”ë“œ
if __name__ == "__main__":
    persona = PlantPersona()
    
    print("=== ì‹ë¬¼ í˜ë¥´ì†Œë‚˜ í…ŒìŠ¤íŠ¸ ===")
    
    # ê¸°ë³¸ ì‘ë‹µ í…ŒìŠ¤íŠ¸
    test_query = "ì•ˆë…•!"
    test_analysis = {'query_type': 'chat', 'tools_needed': []}
    test_results = {}
    
    response = persona.generate_response(test_query, test_analysis, test_results)
    print(f"ì‚¬ìš©ì: {test_query}")
    print(f"ì‹ë¬¼ ì¹œêµ¬: {response}")
    
    # ì¸ì‚¬ë§ í…ŒìŠ¤íŠ¸
    print(f"\nì¸ì‚¬ë§: {persona.get_greeting()}")
    print(f"ì‘ë³„ ì¸ì‚¬: {persona.get_goodbye()}") 